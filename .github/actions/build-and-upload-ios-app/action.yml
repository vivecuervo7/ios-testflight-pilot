name: "Build and Upload iOS App"
description: "Archive, export, and upload iOS app to TestFlight"

inputs:
  environment:
    description: "Environment to build for (dev, staging, prod)"
    required: true
  scheme-name:
    description: "Xcode scheme name to build"
    required: true
  configuration:
    description: "Xcode configuration to use for the build"
    required: true
    default: "Release"
  app-store-connect-api-key:
    description: "App Store Connect API Key content"
    required: true
  app-store-connect-api-key-id:
    description: "App Store Connect API Key ID"
    required: true
  app-store-connect-issuer-id:
    description: "App Store Connect Issuer ID"
    required: true
  keychain-name:
    description: "Name of the keychain to use"
    required: true
  provisioning-profile-base64:
    description: "Base64 encoded provisioning profile for the environment"
    required: true

runs:
  using: "composite"
  env:
    API_PRIVATE_KEYS_DIR: "/tmp/private_keys"
  steps:
    - name: Setup provisioning profile
      shell: bash
      run: |
        echo "Installing provisioning profile into keychain: ${{ inputs.keychain-name }}"

        # Decode and install provisioning profile
        echo "${{ inputs.provisioning-profile-base64 }}" | base64 --decode > profile.mobileprovision

        # Copy to provisioning profiles directory
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

        echo "Provisioning profile installed successfully"

    - name: Build archive
      shell: bash
      run: |
        cd Pilot
        echo "Building archive for ${{ inputs.environment }} environment..."
        mkdir -p build
        xcodebuild archive \
          -project Pilot.xcodeproj \
          -scheme "${{ inputs.scheme-name }}" \
          -configuration "${{ inputs.configuration }}" \
          -archivePath "build/Pilot-${{ inputs.environment }}.xcarchive" \
          -destination "generic/platform=iOS" \

    - name: Export IPA
      shell: bash
      run: |
        cd Pilot
        echo "Exporting IPA for ${{ inputs.environment }} environment..."
        xcodebuild -exportArchive \
          -archivePath "build/Pilot-${{ inputs.environment }}.xcarchive" \
          -exportPath "build/" \
          -exportOptionsPlist ../ExportOptions.plist

    - name: Setup App Store Connect API key
      shell: bash
      run: |
        # Create the API key file in the expected location
        mkdir -p ${{ env.API_PRIVATE_KEYS_DIR }}
        echo "${{ inputs.app-store-connect-api-key }}" > ${{ env.API_PRIVATE_KEYS_DIR }}/AuthKey_${{ inputs.app-store-connect-api-key-id }}.p8

    - name: Upload to TestFlight
      shell: bash
      env:
        API_PRIVATE_KEYS_DIR: ${{ env.API_PRIVATE_KEYS_DIR }}
      run: |
        cd Pilot
        echo "Uploading to TestFlight for ${{ inputs.environment }} environment..."

        # Upload the IPA to TestFlight using altool
        xcrun altool --upload-app \
          -f "build/Pilot.ipa" \
          -t ios \
          --apiKey "${{ inputs.app-store-connect-api-key-id }}" \
          --apiIssuer "${{ inputs.app-store-connect-issuer-id }}" \
          --verbose

    - name: Cleanup temporary files
      if: always()
      shell: bash
      run: |
        # Clean up temporary files
        rm -f profile.mobileprovision
        rm -rf ${{ env.API_PRIVATE_KEYS_DIR }} 2>/dev/null || true
